// intiliazing firebase tied to the aprilsixcreative@gmail.com firebase account 
var $ = jQuery,
    config = {
        apiKey: "AIzaSyAy6M_5Sf8zBeHp8N94Si9xef1mCAMHLww",
        authDomain: "swipe-app-70b28.firebaseapp.com",
        databaseURL: "https://swipe-app-70b28.firebaseio.com",
        projectId: "swipe-app-70b28",
        storageBucket: "swipe-app-70b28.appspot.com",
        messagingSenderId: "562884985657",
        appId: "1:562884985657:web:9e1cf5e120d4553c959ee8",
        measurementId: "G-JZGBPFK6H5"
      
    };
firebase.initializeApp(config);
var uid, db = firebase.database();
firebase.auth().onAuthStateChanged(function(a) {
    if (a) {
        a.isAnonymous;
        uid = a.uid, console.log(uid)
    } else firebase.auth().signInAnonymously().catch(function(a) {
        var b = a.code,
            c = a.message;
        console.log("Please update your settings.")
        console.log(b)
        console.log(c)
    })
});


var questionNumber, 
    sectionRef = db.ref("activeSection");

// watch the database entry : activeSection 
sectionRef.on("value", function(a) {
    questionNumber = a.val();
    var sectiontitle = "#section_" + questionNumber; // format a section title with the selected question number
    showSection(sectiontitle) // fire function to show the correct slide on all windows
});

function showSection(thissection) {
    // when triggered - bring up the correct section in the world page, and close the rest
    $("#page_home")
        .find(thissection)
        .slideDown()
        .siblings("section")
            .slideUp(),

    // and bring up the correct section in the index pages, and close the rest
    $("#section_questions .row")
        .eq(questionNumber)
        .addClass("active")
        .siblings(".row")
            .removeClass("active")
}

// set up variable to check
var leaving = false;

function closeWorld() {
    $("#page_home").length || $("#page_world").length && (
        leaving = true, 
        db.ref("worldOpen").set(false), 
        worldOpen = false
    )
}

window.onbeforeunload = closeWorld, 
$(document).ready(function() {
    
    var c;

    setInterval(function() {
        
        // if there are no other pages open, and leaving has not been set, set worldOpen to true
        $("#page_home").length || 
        ($("#page_world").length && !leaving ? 
            (
                db.ref("worldOpen").set(true), 
                c = true
            ) : 
            (
                db.ref("worldOpen").set(false), 
                c = false
            )
        )
    }), 
    $("#page_world").length && 
    $("#section_questions .row").on("click", function() {
        var thischoice = $(this).data("choice");
        db.ref("activeSection").set(thischoice)
    });

    var d = true;

    // when a user submits an answer
    if ($("body")
        .on("submit", "form", function(event) {
            event.preventDefault();

            var useranswer = $(this).find(".user-answer"),
                answervalue = useranswer.val() || null;

                
            null !== answervalue && 
            (createanswer(questionNumber, answervalue),

            $(`#page_home #section_${questionNumber}.answer-box`)
                .addClass("answered")), 

            setTimeout(function() {
                useranswer.val("")
            }, 1000), 
            
            setTimeout(function() {
                d = true
            }, 1000)
    }), 

    $("#section_1").length) {
        var e = document.getElementById("section_1"),
            f = new Hammer(e);
        f.on("pan", function() {
            d && 1 === questionNumber && (console.log(1), 
            d = false, 
            submitform("#section_1"))
        })
    }
    if ($("#section_2").length) {
        var e = document.getElementById("section_2"),
            f = new Hammer(e);
        f.on("pan", function() {
            d && 2 === questionNumber && (console.log(2), 
            d = false, 
            submitform("#section_2"))
        })
    }
    if ($("#section_3").length) {
        var e = document.getElementById("section_3"),
            f = new Hammer(e);
        f.on("pan", function() {
            d && 3 === questionNumber && (console.log(3), d = false, submitform("#section_3"))
        })
    }
    if ($("#section_4").length) {
        var e = document.getElementById("section_4"),
            f = new Hammer(e);
        f.on("pan", function() {
            d && 4 === questionNumber && (console.log(4), d = false, submitform("#section_4"))
        })
    }


    // if on the world page
    if ($("#page_world").length) { 
        // watch for changes in the firebase database
        db.ref("answers").once("value", function(thisquestionset) { 
            // and trigger this function if changes are present
            var answerval = thisquestionset.val();
            $.each(b, function(thisquestionset, answerval) {
                var questionsetcopy = thisquestionset,
                    d = answerval;
                void 0 != d && 
                null != answerval && 
                $.each(d, function(thisanswer) {
                    db.ref(`answers/${questionsetcopy}/${thisanswer}/new`).set(false)
                })
            })
        });

        var g = db.ref("answers/1");
        g.on("value", function(answer) {
            var answervalue = answer.val(),
                answers1 = $("#world_answers_1");
            answers1.html(""), 
            $.each(answervalue, function(a, answervalue) {
                var newanswer;
                newanswer = answervalue.new ? `<li class="new-answer"><p>${answervalue.text}</p></li>` : `<li><p>${answervalue.text}</p></li>`, 
                answers1.prepend(newanswer);
            })
        });
        var h = db.ref("answers/2");
        h.on("value", function(a) {
            var b = a.val(),
                c = $("#world_answers_2");
            c.html(""), $.each(b, function(a, b) {
                var d;
                d = b.new ? `<li class="new-answer"><p>${b.text}</p></li>` : `<li><p>${b.text}</p></li>`, 
                c.prepend(d)
            })
        });
        var i = db.ref("answers/3");
        i.on("value", function(a) {
            var b = a.val(),
                c = $("#world_answers_3");
            c.html(""), $.each(b, function(a, b) {
                var d;
                d = b.new ? `<li class="new-answer"><p>${b.text}</p></li>` : `<li><p>${b.text}</p></li>`, 
                c.prepend(d)
            })
        })
        var i = db.ref("answers/4");
        i.on("value", function(a) {
            var b = a.val(),
                c = $("#world_answers_4");
            c.html(""), $.each(b, function(a, b) {
                var d;
                d = b.new ? `<li class="new-answer"><p>${b.text}</p></li>` : `<li><p>${b.text}</p></li>`, 
                c.prepend(d)
            })
        })
    }

    function createanswer(answerset, answervalue) {
        var answerid = Date.now();
        db.ref("answers/" + answerset + "/" + answerid).set({
            new: true,
            text: answervalue
        })
    }

    function submitform(thisform) {
        $(thisform).find("form").submit()
    }

});