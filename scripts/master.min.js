// intiliazing firebase tied to the aprilsixcreative@gmail.com firebase account 
var $ = jQuery,
    config = {
        apiKey: "AIzaSyADsCeNsb2yV8AIN-TTmoLsfhZ_ESrsi8M",
        authDomain: "test-swipe-app.firebaseapp.com",
        databaseURL: "https://test-swipe-app.firebaseio.com",
        projectId: "test-swipe-app",
        storageBucket: "test-swipe-app.appspot.com",
        messagingSenderId: "513276763632",
        appId: "1:513276763632:web:6a28ac9b7b12cbd3815135",
        measurementId: "G-HMLSHNCQ2M"
    
      
    };
firebase.initializeApp(config);
var uid, db = firebase.database();
firebase.auth().onAuthStateChanged(function(a) {
    if (a) {
        a.isAnonymous;
        uid = a.uid, console.log(uid)
    } else firebase.auth().signInAnonymously().catch(function(a) {
        var b = a.code,
            c = a.message;
        console.log("Please update your settings.")
        console.log(b)
        console.log(c)
    })
});


var questionNumber, 
    sectionRef = db.ref("activeSection");

// watch the database entry : activeSection 
sectionRef.on("value", function(a) {
    questionNumber = a.val();    
    document.question = questionNumber;

    var sectiontitle = "#section_" + questionNumber; // format a section title with the selected question number
    showSection(sectiontitle) // fire function to show the correct slide on all windows
});

function showSection(thissection) {
    // when triggered - bring up the correct section in the world page, and close the rest
    $("#page_home")
        .find(thissection)
        .slideDown()
        .siblings("section")
            .slideUp(),

    // and bring up the correct section in the index pages, and close the rest
    $("#section_questions .row")
        .eq(questionNumber)
        .addClass("active")
        .siblings(".row")
            .removeClass("active")
}

// set up variable to check
var leaving = false;

function closeWorld() {
    $("#page_home").length || $("#page_world").length && (
        leaving = true, 
        db.ref("worldOpen").set(false), 
        worldOpen = false
    )
}

window.onbeforeunload = closeWorld, 
$(document).ready(function() {
    // let questionNumber = document.question;
    // console.log(questionNumber)
    // console.log('questionNumber')

    
    var c;

    setInterval(function() {
        
        // if there are no other pages open, and leaving has not been set, set worldOpen to true
        $("#page_home").length || 
        ($("#page_world").length && !leaving ? 
            (
                db.ref("worldOpen").set(true), 
                c = true
            ) : 
            (
                db.ref("worldOpen").set(false), 
                c = false
            )
        )
    }), 
    // saving active answer to database entry on clikc from world page
    $("#page_world").length && 
    $("#section_questions .row").on("click", function() {
        var thischoice = $(this).data("choice");
        db.ref("activeSection").set(thischoice)
        console.log('submitting answer');
    });

    var d = true;
    
    // when a user submits an answer
    $("body")
    .on("submit", "form", function(event) {
        console.log('preventing submission form')
        event.preventDefault();
        let questionNumber = document.question;

        var useranswer = $(this).find(".user-answer"),
            answervalue = useranswer.val() || null;

        if( answervalue != null ) {
            console.log(`#page_home #section_${questionNumber}.answer-box`)
        
            createanswer(questionNumber, answervalue);
            $(`#answer_box_${questionNumber}.answer-box`)
                .addClass("answered");

            setTimeout(function() {
                useranswer.val("")
            }, 1000);
            
            setTimeout(function() {
                d = true
            }, 1000);
        };
    });
    var e = [];
    [1,2,3,4].forEach(function(a,i) {
        if ($(`#section_${i}`).length) {
             e[i] = document.getElementById(`#section_${i}`), f = new Hammer(e[i]);
            f.on("pan", function() {
                d && i === questionNumber && (console.log(i), d = false, submitform(`#section_${i}`))
            })
        }
    })


    // if on the world page
    if ($("#page_world").length) { 
        // watch for changes in the firebase database
        db.ref("answers").once("value", function(thisquestionset) { 
            // and trigger this function if changes are present
            var answerval = thisquestionset.val();
            $.each(answerval, function(thisquestionset, answerval) {
                var questionsetcopy = thisquestionset,
                    d = answerval;
                void 0 != d && 
                null != answerval && 
                $.each(d, function(thisanswer) {
                    db.ref(`answers/${questionsetcopy}/${thisanswer}/new`).set(false)
                })
            })
        });
        var a = [], answers = [];
        //for this answer, reference answers/1 from the database
        [1,2,3,4].forEach(function(ab,i){
            
            a[i] = db.ref(`answers/${i+1}`);
            a[i].on("value", function(answer) {
                var answervalue = answer.val();
                answers[i] = $(`#world_answers_${i}`);
                //reset answers
                answers[i].html(""), 
                // populate section with the submitted answers
                $.each(answervalue, function(a, answervalue) {
                    var newanswer;
                    newanswer = answervalue.new ? `<li class="new-answer"><p>${answervalue.text}</p></li>` : `<li><p>${answervalue.text}</p></li>`, 
                    answers[i].prepend(newanswer);
                })
            });
        })
    }

    function createanswer(answerset, answervalue) {
        var answerid = Date.now();
        db.ref("answers/" + answerset + "/" + answerid).set({
            new: true,
            text: answervalue
        })
    }

    function submitform(thisform) {
        var useranswer = $(thisform).find(".user-answer"),
        answervalue = useranswer.val() || [];
        
        // console.log(answervalue.length)
        if (answervalue.length !== 0) {
            $(thisform).find("form").submit()

        } else {
            d = true;
        }
        
    }

});